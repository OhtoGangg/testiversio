const { Client, GatewayIntentBits } = require('discord.js');
const axios = require('axios');
const fs = require('fs');

const TOKEN = 'MTQxMzA2MTE2ODk3Njc2MDg0Ng.G_hu9I.qmF8iWsoB6hcvwplznbCGTDOPzftxMUBsFalAM'; // Discord-botin token
const GUILD_ID = '1413060079611154595'; // Discord palvelimen ID
const LIVESSA_ROLE_ID = '1413060382947278918'; // Rooli, jonka lisäät/laitat pois
const MAINOSTUS_CHANNEL_ID = '1413060218300006420'; // Viestikanavan ID missä ilmoitukset näkyvät
const YOUR_STRIIMAAJA_ROLE_ID = '1413060344972316724';
const TWITCH_CLIENT_ID = 'nbrj1v8b1mwh963aswrw24lj6x33v9'; // Twitch API Client ID
const TWITCH_ACCESS_TOKEN = 'vh64wcuewy9be1w5t1eg3zshxs1itq'; // Twitch API Access Token

const dataFilePath = './data.json';
let userData = {};

try {
    const rawData = fs.readFileSync(dataFilePath, 'utf8');
    userData = JSON.parse(rawData);
} catch (err) {
    console.log('Ei voitu lukea data.json-tiedostoa, luodaan uusi.');
    userData = {};
}

// Tallennusfunktio
function saveData() {
    fs.writeFileSync(dataFilePath, JSON.stringify(userData, null, 2));
}

// Discord-asiakas
const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMembers, GatewayIntentBits.GuildMessages, GatewayIntentBits.GuildVoiceStates] });

client.once('ready', async () => {
    console.log(`Kirjauduttu sisään nimellä ${client.user.tag}`);

    const guild = await client.guilds.fetch(GUILD_ID);
    const members = await guild.members.fetch();

    // Tarkistetaan säännöllisesti
    setInterval(async () => {
        for (const member of members.values()) {
            // Tarkistetaan, onko jäsenellä "Striimaaja" rooli
            if (member.roles.cache.has(STRIIMAAJA_ROLE_ID)) {
                const twitchUsername = member.displayName; // Oletetaan, että Twitch-käyttäjänimi on nimi
                try {
                    const response = await axios.get('https://api.twitch.tv/helix/streams', {
                        headers: {
                            'Client-ID': TWITCH_CLIENT_ID,
                            'Authorization': `Bearer ${TWITCH_ACCESS_TOKEN}`
                        },
                        params: {
                            user_login: twitchUsername
                        }
                    });
                    const isLive = response.data.data.length > 0;
                    const memberId = member.id;

                    if (!userData[memberId]) {
                        userData[memberId] = {};
                    }

                    const currentlyLive = userData[memberId]._isLive || false;

                    // Jos menee liveen
                    if (isLive && !currentlyLive) {
                        const channel = guild.channels.cache.get(MAINOSTUS_CHANNEL_ID);
                        const message = await channel.send(`${member.user.username} aloitti striimin! Katso tästä: ${getTwitchUrl(twitchUsername)}`);

                        // Lisää "LIVESSÄ" rooli
                        await member.roles.add(LIVESSA_ROLE_ID);

                        // Päivitä data
                        userData[memberId]._isLive = true;
                        userData[memberId]._liveMessageId = message.id;
                        saveData();
                    }
                    // Jos lopettaa striimin
                    else if (!isLive && currentlyLive) {
                        const channel = guild.channels.cache.get(MAINOSTUS_CHANNEL_ID);
                        const messageId = userData[memberId]._liveMessageId;
                        if (messageId) {
                            try {
                                const msg = await channel.messages.fetch(messageId);
                                await msg.delete();
                            } catch (err) {
                                console.log('Viestin poisto epäonnistui:', err);
                            }
                        }
                        // Poista "LIVESSÄ" rooli
                        await member.roles.remove(LIVESSA_ROLE_ID);

                        // Päivitä data
                        userData[memberId]._isLive = false;
                        userData[memberId]._liveMessageId = null;
                        saveData();
                    }
                } catch (err) {
                    console.error('Virhe Twitch API:ssä:', err);
                }
            }
        }
    }, 60000); // tarkistaa minuutin välein
});

// Funktio Twitch URL:lle
function getTwitchUrl(username) {
    return `https://www.twitch.tv/${username}`;
}

client.login(TOKEN);
